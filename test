import streamlit as st
import pandas as pd
import plotly.express as px
from datetime import datetime

# 1. KONFIGURASI HALAMAN (Tampilan Mewah)
st.set_page_config(page_title="Kasir Jaya Digital", layout="wide", page_icon="ğŸª")

# 2. DATABASE BARANG (Silakan edit harga di sini)
if 'master_barang' not in st.session_state:
    st.session_state.master_barang = {
        "Kopi Espresso": 15000,
        "Roti Bakar": 20000,
        "Air Mineral": 5000,
        "Teh Manis": 8000,
        "Indomie Telur": 12000
    }

# 3. INISIALISASI DATA TRANSAKSI
if 'data' not in st.session_state:
    st.session_state.data = pd.DataFrame(columns=['Tipe', 'Kategori', 'Jumlah', 'Tanggal'])

# 4. CSS UNTUK DESAIN MODERN (INFOGRAFIS)
st.markdown("""
    <style>
    [data-testid="stMetricValue"] { font-size: 28px; color: #1E88E5; }
    .stButton>button { width: 100%; border-radius: 20px; background-color: #1E88E5; color: white; }
    .header-box {
        text-align: center;
        padding: 30px;
        background: linear-gradient(to right, #1e3c72, #2a5298);
        color: white;
        border-radius: 15px;
        margin-bottom: 20px;
    }
    </style>
    """, unsafe_allow_html=True)

# 5. HEADER (Logo & Nama Toko)
st.markdown("""
    <div class="header-box">
        <h1>ğŸª KASIR JAYA DIGITAL</h1>
        <p>Sistem Manajemen Keuangan Modern & Cepat</p>
    </div>
    """, unsafe_allow_html=True)

# 6. NAVIGASI SIDEBAR
with st.sidebar:
    st.title("ğŸ“Œ MENU UTAMA")
    menu = st.radio("Pilih Halaman:", ["ğŸ›’ Mesin Kasir", "ğŸ“¦ Tambah Produk", "ğŸ“Š Laporan & Grafik"])
    st.divider()
    st.write("Status: **Aktif**")

# --- HALAMAN 1: MESIN KASIR ---
if menu == "ğŸ›’ Mesin Kasir":
    st.subheader("ğŸ“ Input Transaksi")
    col1, col2 = st.columns([2, 1])
    
    with col1:
        with st.expander("âœ¨ Pilih Produk (Otomatis)", expanded=True):
            daftar_pilihan = ["--- Pilih Barang ---"] + list(st.session_state.master_barang.keys())
            barang_sel = st.selectbox("Cari Produk:", daftar_pilihan)
            qty = st.number_input("Jumlah Beli:", min_value=1, value=1)
            
            harga_satuan = st.session_state.master_barang.get(barang_sel, 0)
            total_harga = harga_satuan * qty
            
            if barang_sel != "--- Pilih Barang ---":
                st.info(f"Subtotal: **Rp {total_harga:,.0f}**")
                if st.button("â• Tambah ke Kasir"):
                    new_row = pd.DataFrame({'Tipe': ['Pemasukan'], 'Kategori': [barang_sel], 'Jumlah': [total_harga], 'Tanggal': [datetime.today().date()]})
                    st.session_state.data = pd.concat([st.session_state.data, new_row], ignore_index=True)
                    st.success("Barang ditambahkan!")

    with col2:
        with st.expander("âœï¸ Input Manual"):
            tipe_m = st.selectbox("Jenis:", ["Pemasukan", "Pengeluaran"])
            nama_m = st.text_input("Keterangan:", placeholder="Misal: Bayar Air")
            jumlah_m = st.number_input("Nominal (Rp):", min_value=0)
            if st.button("ğŸ’¾ Simpan Manual"):
                if nama_m and jumlah_m > 0:
                    new_row = pd.DataFrame({'Tipe': [tipe_m], 'Kategori': [nama_m], 'Jumlah': [jumlah_m], 'Tanggal': [datetime.today().date()]})
                    st.session_state.data = pd.concat([st.session_state.data, new_row], ignore_index=True)
                    st.success("Data tersimpan!")

# --- HALAMAN 2: TAMBAH PRODUK ---
elif menu == "ğŸ“¦ Tambah Produk":
    st.subheader("âš™ï¸ Kelola Daftar Barang")
    with st.form("tambah_barang"):
        nama_baru = st.text_input("Nama Produk Baru:")
        harga_baru = st.number_input("Harga (Rp):", min_value=0)
        if st.form_submit_button("âœ… Masukkan ke Daftar"):
            if nama_baru and harga_baru > 0:
                st.session_state.master_barang[nama_baru] = harga_baru
                st.success(f"{nama_baru} sekarang tersedia di menu Kasir!")

# --- HALAMAN 3: LAPORAN ---
else:
    st.subheader("ğŸ“Š Laporan Infografis")
    in_sum = st.session_state.data[st.session_state.data['Tipe'] == 'Pemasukan']['Jumlah'].sum()
    out_sum = st.session_state.data[st.session_state.data['Tipe'] == 'Pengeluaran']['Jumlah'].sum()
    
    # Infografis Metrics
    c1, c2, c3 = st.columns(3)
    c1.metric("ğŸ’° Saldo", f"Rp {in_sum - out_sum:,.0f}")
    c2.metric("ğŸ“ˆ Masuk", f"Rp {in_sum:,.0f}")
    c3.metric("ğŸ“‰ Keluar", f"Rp {out_sum:,.0f}")
    
    st.divider()
    
    col_a, col_b = st.columns(2)
    with col_a:
        if not st.session_state.data.empty:
            fig = px.pie(st.session_state.data, values='Jumlah', names='Tipe', hole=0.5, title="Arus Kas")
            st.plotly_chart(fig, use_container_width=True)
    with col_b:
        st.write("**Riwayat Transaksi**")
        st.dataframe(st.session_state.data, use_container_width=True)
